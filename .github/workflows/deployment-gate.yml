name: Deployment Gate - Performance Check

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  FUSION_AUTH_API_KEY: ${{ secrets.FUSION_AUTH_API_KEY }}
  FUSION_AUTH_BASE_URI: ${{ secrets.FUSION_AUTH_BASE_URI }}
  LOCUST_USERNAME: ${{ secrets.LOCUST_USERNAME }}
  LOCUST_USER_PASSWORD: ${{ secrets.LOCUST_USER_PASSWORD }}

on:
  workflow_dispatch:

jobs:
  performance-gate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: pip install -r requirements.txt
    
    - name: Run baseline load test
      run: |
        locust \
          --headless \
          --users 50 \
          --spawn-rate 10 \
          --run-time 2m \
          --host ${{ secrets.STG_URL }} \
          --csv baseline
    
    - name: Check if deployment should proceed
      id: gate_check
      run: |
        python scripts/check_thresholds.py baseline_stats.csv
        echo "gate_passed=true" >> $GITHUB_OUTPUT
      continue-on-error: true
    
    - name: Comment on PR with results - Success
      if: steps.gate_check.outcome == 'success'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const stats = fs.readFileSync('baseline_stats.csv', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ” Load Test Results\n\nâœ… Performance tests passed\n\nSee artifacts for detailed results.`
          })

    - name: Comment on PR with results - Failure
      if: steps.gate_check.outcome != 'success'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const stats = fs.readFileSync('baseline_stats.csv', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ” Load Test Results\n\nâŒ Performance degradation detected\n\nSee artifacts for detailed results.`
          })
    
    - name: Block deployment if thresholds breached
      if: steps.gate_check.outcome != 'success'
      run: |
        echo "â›” Deployment blocked due to performance degradation"
        exit 1